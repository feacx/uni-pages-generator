const t={name:"monitor",server_url:"https://api.xxx.com/byte.gif",send_timeout:1e3,show_log:!0,autoTrack:{appLaunch:!0,appShow:!0,appHide:!0,pageShow:!0,pageShare:!0,pageLoad:!0,pageHide:!0,pageUnload:!0,mpClick:!0,mpFavorite:!0,pageLeave:!0},batch_send:!0,storage_store_key:"monitor_storage_2022",storage_store_user_key:"monitor_storage_2022"},e=(t,e)=>{if(n(e))return t;const o=(t=>{let e="";for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e+=`${n}=${t[n]}`);return e})(e||{});return`${t}${o?`?${o}`:""}`},n=t=>{if(s(t)){for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}return!1},o=(t=1)=>{try{const e=getCurrentPages();return e[e.length-t].route}catch(t){return wx.getLaunchOptionsSync().path}},r=(t=1)=>{try{const n=getCurrentPages(),o=n[n.length-t];return e(o.route,o.options)}catch(t){const n=wx.getLaunchOptionsSync();return e(n.path,n.query)}},a=()=>{if(getCurrentPages().length>1)return r(2);const t=wx.getLaunchOptionsSync();return e(t.path,t.query)},i=t=>{const e={...wx.getStorageSync("monitor_storage_2022"),...t};c(e)},c=t=>{wx.setStorageSync("monitor_storage_2022",t)},s=t=>null!=t&&"[object Object]"==Object.prototype.toString.call(t),p=()=>(new Date).getTime(),g=()=>{let t=p();return Math.ceil((t=(9301*t+49297)%233280)/233280*1e19)/1e19},u=t=>{var e="";try{e=decodeURIComponent(t)}catch(n){e=t}return e},l=t=>{console.error("数据上报错误",t)},_=(e,n,o,r)=>{const a=h(e,n);r&&console.log(a),((t,e)=>{wx.request({url:e,method:"POST",data:t,success(t){},fail(t){l(t)}})})(a,o||t.server_url)},h=(t,e)=>{const n=wx.getStorageSync("monitor_storage_2022"),i={$referrer:a()||"",$url:o(),$url_path:r()};return{distinct_id:d(),anonymous_id:f(),login_id:m(),openid:y(),properties:{...n,...e,...i},type:"track",event:t,time:p()}},d=()=>{let t=S();if(t.distinct_id)return t.distinct_id;{const t=f();return w("distinct_id",t),d()}},m=()=>{let t=S();return t.login_id?(w("distinct_id",t.login_id),t.login_id):""},y=()=>{let t=S();return t.openid?(w("distinct_id",t.openid),t.openid):""},f=()=>{let t=S();if(t.anonymous_id)return t.anonymous_id;{const t=Date.now()+"-"+Math.floor(1e7*g())+"-"+g().toString(16).replace(".","")+"-"+String(31242*g()).replace(".","").slice(0,8);return w("anonymous_id",t),f()}},w=(t,e)=>{const n=S();n[t]=e,wx.setStorageSync(x.storage_store_user_key,n)},S=()=>wx.getStorageSync(x.storage_store_user_key)||{};class ${constructor(){this.pageEvent=function(t){if(k.config.autoTrack.pageLoad){const e="onLoad";if(t[e]){const n=t[e];t[e]=function(){k.track("$PageLoad",{}),n.apply(this,arguments)}}}if(k.config.autoTrack.pageShow){const e="onShow";if(t[e]){const n=t[e];t[e]=function(){k.track("$PageShow",{}),n.apply(this,arguments)}}}if(k.config.autoTrack.pageUnload){const e="onUnload";if(t[e]){const n=t[e];t[e]=function(){k.track("$PageUnload",{}),n.apply(this,arguments)}}}if(k.config.autoTrack.pageHide){const e="onHide";if(t[e]){const n=t[e];t[e]=function(){k.track("$PageHide",{}),n.apply(this,arguments)}}}if(k.config.autoTrack.pageShare){const e="onShareAppMessage";if(t[e]){const n=t[e];t[e]=function(){k.track("$pageShare",{}),n.apply(this,arguments)}}const n="onShareTimeline";if(t[n]){const e=t[n];t[n]=function(){k.track("$pageShare",{}),e.apply(this,arguments)}}}},this.init()}init(){const t=k.config;s(t)&&(t.autoTrack&&t.autoTrack.appLaunch&&this.appLaunch(),t.autoTrack&&t.autoTrack.appShow&&this.appShow(),t.autoTrack&&t.autoTrack.appHide&&this.appHide(),this.pageMonitor())}appLaunch(){k.track("$MPLaunch",{})}appShow(){wx.onAppShow((t=>{k.track("$MPShow",{})}))}appHide(){wx.onAppShow((t=>{k.track("$MPHide",{})}))}pageMonitor(){const t=this,e=Page;Page=function(n){try{n||(n={}),t.pageEvent(n),e.apply(this,arguments)}catch(n){e.apply(this,arguments)}};const n=Component;Component=function(e){try{e||(e={}),e.methods||(e.methods={}),t.pageEvent(e.methods),n.apply(this,arguments)}catch(e){n.apply(this,arguments)}}}}const k={},x={...t},P=async t=>{v(t),await(t.name,Promise.all([new Promise(((t,e)=>{wx.getNetworkType({success(e){t(e)},fail(t){e(t)}})})),new Promise(((t,e)=>{wx.getSystemInfoAsync({success(e){const n={$lib:"MiniProgram",$lib_version:"0.1",$wifi_enabled:e.wifiEnabled,$brand:e.brand,$model:e.model,$screen_width:e.screenWidth,$screen_height:e.screenHeight,$os:e.platform,$os_version:e.system,$mp_client_app_version:e.version,$mp_client_basic_library_version:e.SDKVersion};i(n),t(e)},fail(t){e(t)}})}))]).catch((t=>{console.log("初始化失败",t)}))),x.name=t.name,x.miniprogram_name=t.miniprogram_name,k.track=T,k.config=x,k.setOpenid=b,k.login=L,k.miniprogram_name=t.miniprogram_name;const e=wx.getAccountInfoSync();k.appid=e.miniProgram.appId;getApp()[t.name]=k,(t=>{const e=wx.getLaunchOptionsSync(),n={$app_id:k.appid,$latest_scene:e.scene,$miniprogram_name:k.miniprogram_name},o=["utm_campaign","utm_content","utm_medium","utm_source","utm_term"];for(let t=0;t<o.length;t++){const r=o[t];e.query[r]&&(n[`$${r}`]=u(e.query[r]))}i(n)})(t.name),new $},v=t=>{wx.removeStorageSync(t.storage_store_key),wx.removeStorageSync(t.storage_store_user_key)},T=(t,e)=>{_(t,e,"",x.show_log)},b=t=>{w("openid",t),m()||w("distinct_id",t)},L=t=>{w("distinct_id",t),w("login_id",t),T("$BindId",{})};export{x as globalConfig,L as login,k as monitor,b as setOpenid,P as setParam,T as track};
