"use strict";const t={name:"monitor",server_url:"https://api.xxx.com/byte.gif",send_timeout:1e3,show_log:!0,autoTrack:{appLaunch:!0,appShow:!0,appHide:!0,pageShow:!0,pageShare:!0,pageLoad:!0,pageHide:!0,pageUnload:!0,mpClick:!0,mpFavorite:!0,pageLeave:!0},batch_send:!0,storage_store_key:"monitor_storage_2022"},e=(t,e)=>{if(o(e))return t;const n=(t=>{let e="";for(const o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e+=`${o}=${t[o]}`);return e})(e||{});return`${t}${n?`?${n}`:""}`},o=t=>{if(p(t)){for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}return!1},n=()=>getApp(),a=(t=1)=>{try{const e=getCurrentPages();return e[e.length-t].route}catch(t){return wx.getLaunchOptionsSync().path}},i=(t=1)=>{try{const o=getCurrentPages(),n=o[o.length-t];return e(n.route,n.options)}catch(t){const o=wx.getLaunchOptionsSync();return e(o.path,o.query)}},r=()=>{if(getCurrentPages().length>1)return i(2);const t=wx.getLaunchOptionsSync();return e(t.path,t.query)},s=t=>{const e={...wx.getStorageSync("monitor_storage_2022"),...t};c(e)},c=t=>{wx.setStorageSync("monitor_storage_2022",t)},p=t=>null!=t&&"[object Object]"==Object.prototype.toString.call(t),g=()=>(new Date).getTime(),h=()=>{let t=g();return Math.ceil((t=(9301*t+49297)%233280)/233280*1e19)/1e19},l=t=>{console.error("数据上报错误",t)},u=(e,o,n,a)=>{const i=d(e,o);a&&console.log(i),((t,e)=>{wx.request({url:e,method:"POST",data:t,success(t){},fail(t){l(t)}})})(i,n||t.server_url)},d=(t,e)=>{const o=wx.getStorageSync("monitor_storage_2022"),n={$referrer:r()||"",$url:a(),$url_path:i()};return{distinct_id:_(),anonymous_id:y(),login_id:m(),openid:w(),properties:{...o,...e,...n},type:"track",event:t,time:g()}},_=()=>{let t=f();if(t.distinct_id)return t.distinct_id;{const t=y();return S("distinct_id",t),_()}},m=()=>{let t=f();return t.login_id?(S("distinct_id",t.login_id),t.login_id):""},w=()=>{let t=f();return t.openid?(S("distinct_id",t.openid),t.openid):""},y=()=>{let t=f();if(t.anonymous_id)return t.anonymous_id;{const t=Date.now()+"-"+Math.floor(1e7*h())+"-"+h().toString(16).replace(".","")+"-"+String(31242*h()).replace(".","").slice(0,8);return S("anonymous_id",t),y()}},S=(t,e)=>{const o=f();o[t]=e,wx.setStorageSync("monitor_storage_2022_user",o)},f=()=>wx.getStorageSync("monitor_storage_2022_user")||{};class ${constructor(t){this.pageEvent=t=>{this.app.config.autoTrack.pageLoad&&(t.onLoad=()=>{this.app.track("$PageLoad",{})}),this.app.config.autoTrack.pageShow&&(t.onShow=()=>{console.log("Show"),this.app.track("$PageShow",{})}),this.app.config.autoTrack.pageUnload&&(t.onUnload=()=>{console.log("Unload"),this.app.track("$PageUnload",{})}),this.app.config.autoTrack.pageHide&&(t.onHide=()=>{console.log("Hide"),this.app.track("$PageHide",{})})},this.app=t,this.init()}init(){const t=this.app.config;p(t)&&(t.autoTrack&&t.autoTrack.appLaunch&&this.appLaunch(),t.autoTrack&&t.autoTrack.appShow&&this.appShow(),t.autoTrack&&t.autoTrack.appHide&&this.appHide(),this.pageMonitor())}appLaunch(){this.app.track("$MPLaunch",{})}appShow(){wx.onAppShow((t=>{this.app.track("$MPShow",{})}))}appHide(){wx.onAppShow((t=>{this.app.track("$MPHide",{})}))}pageMonitor(){const t=this;var e=Page;Page=function(o){try{o||(o={}),t.pageEvent(o),e.apply(this,arguments)}catch(o){e.apply(this,arguments)}};var o=Component;Component=function(e){try{e||(e={}),t.pageEvent(e.methods||{}),o.apply(this,arguments)}catch(e){o.apply(this,arguments)}}}}exports.Analytics=class{constructor(e){this.app={},this.config={...t,...e},this.init()}async init(){this.clearData(),await(this.config.name,Promise.all([new Promise(((t,e)=>{wx.getNetworkType({success(e){t(e)},fail(t){e(t)}})})),new Promise(((t,e)=>{wx.getSystemInfoAsync({success(e){const o={$lib:"MiniProgram",$lib_version:"0.1",$wifi_enabled:e.wifiEnabled,$brand:e.brand,$model:e.model,$screen_width:e.screenWidth,$screen_height:e.screenHeight,$os:e.platform,$os_version:e.system,$mp_client_app_version:e.version,$mp_client_basic_library_version:e.SDKVersion};s(o),t(e)},fail(t){e(t)}})}))]).catch((t=>{console.log("初始化失败",t)}))),this.app=getApp(),this.app[this.config.name]={};const t=this.app[this.config.name];t.track=this.track,t.config=this.config,t.setOpenid=this.setOpenid,t.login=this.login,t.miniprogram_name=this.config.miniprogram_name;const e=wx.getAccountInfoSync();t.appid=e.miniProgram.appId,(t=>{const e=wx.getLaunchOptionsSync(),o={$app_id:n()[t].appid,$latest_scene:e.scene,$miniprogram_name:n()[t].miniprogram_name};s(o)})(this.config.name),new $(t)}track(t,e){u(t,e,"",this.config.show_log)}setOpenid(t){S("openid",t),m()||S("distinct_id",t)}login(t){S("login_id",t)}clearData(){wx.removeStorageSync("monitor_storage_2022"),wx.removeStorageSync("monitor_storage_2022_user")}};
